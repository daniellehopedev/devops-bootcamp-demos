# Module 10: Container Orchestration with Kubernetes

### Demo Project:
Create Helm Chart for Microservices

### Technologies Used:
Kubernetes, Helm

### Project Objectives:
- Create 1 shared Helm Chart for all microservices, to reuse common Deployment and Service configurations for the services.
---
### Create Helm Chart
config.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/config.yaml

1. two main ways to create helm charts
    - one helm chart for each microservice
        - when configurations are very different
    - one shared helm chart for all microservices
    - can use a combination of both of the above options
        - shared chart for similar applications
        - separate charts for completely different apps
2. for this demo, we will create a shared chart
    - `helm create <chart-name>`
        - creates a directory
            - Chart.yaml
            - values.yaml (will have the actual values for the template files)
            - charts folder (holds chart dependencies)
            - templates folder (where the actual K8s YAML files (template files) are created)
            - .helmignore (designate files to not include in the helm chart)
3. setup template files
    - remove the autogenerated files from the templates folder, except deployment.yaml and service.yaml
    - delete contents of deployment.yaml, service.yaml, and values.yaml
4. create template files
    - "Values" Object
        - a built-in object
        - empty by default
        - values are passed into the template from 3 sources
            - values.yaml file in the chart
            - user-supplied file passed with -f flag
            - parameter passed with --set flag
    - service.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/charts/microservice/templates/service.yaml
    - deployment.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/charts/microservice/templates/deployment.yaml
    - values.yaml (setting default values): https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/charts/microservice/values.yaml
5. create specific values template file for each service
    - `helm template -f <template-file-name> <chart-name>`
        - render chart templates locally and display the output (used to validate template values are being used)
    - `helm lint`
        - checks chart for possible issues
            - ERROR = issues that will cause the chart to fail installation
            - WARNING = issues that break with convention or recommendations
    - email-service-values.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/values/email-service-values.yaml
        - deploy the email service
        - `helm install -f email-service-values.yaml emailservice microservice`
    - values folder with all of the yaml files for each service: https://github.com/daniellehopedev/kubernetes-demos/tree/main/kubernetes-microservices-helm/values
6. create a chart for redis
    - service.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/charts/redis/templates/service.yaml
    - deployment.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/charts/redis/templates/deployment.yaml
    - values.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/charts/redis/values.yaml
    - redis-values.yaml: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/values/redis-values.yaml
7. check generated manifest
    - `helm install --dry-run -f <service-values-yaml> <release-name> <chart-name>` command
        - check generated manifest without installing the chart
        - --dry-run sends files to K8s cluster, while template only validates it locally
---
---
### Demo Project:
Deploy Microservices with Helmfile

### Technologies Used:
Kubernetes, Helm, Helmfile

### Project Objectives:
- Deploy Microservices with Helm
- Deploy Microservices with Helmfile
---
### Deployment
1. 2 options
    - using helm install command one by one for each service or write a script file with all of the commands
        - install script: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/install.sh
        - uninstall script: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/uninstall.sh
    - using helmfile
        - declarative way for deploying helm charts
        - define the desired state
        - declare a definition of an entire K8s cluster
        - change specification depending on application or type of environment
2. using helmfile
    - install helmfile `brew install helmfile`
3. run helmfile command `helmfile sync`
    - helmfile: https://github.com/daniellehopedev/kubernetes-demos/blob/main/kubernetes-microservices-helm/helmfile.yaml
    - helmfile list = shows currently installed releases
4. access the microservices frontend with localhost using port-forward
    - `kubectl port-forward <deployment-name> <port>`
5. uninstall releases `helmfile destroy`